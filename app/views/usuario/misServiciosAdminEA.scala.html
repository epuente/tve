@(estado:Long, numFolio:Long)
@import helper._

@estado  @numFolio
@main{
	<style>
	.vbottom{
	    position: relative;
	    top: 100%;
	    transform: translateY(-100%); 
	}
	
	.selected {    
	    color: black;
	}
		
	.filtrado {
	    background-color:#ffffcc;
	}
	
	ul.a {
	    list-style-type: circle;
	}
	
	.conError {
		color: red;
	}
	
	.sidenav5 {
	/*     position: fixed; */
	    z-index: 5;
	    overflow-x: hidden;
	    transition: 1.5s;
	   /* background-color: white;*/
	}
	
	[data-notify="progressbar"] {
	    margin-bottom: 0px;
	    position: absolute;
	    bottom: 0px;
	    left: 0px;
	    width: 100%;
	    height: 5px;
	}
	</style>
	
	@ventanasModales()   
	<br> 
    <div class="row">
    	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"><h1>Mis servicios</h1></div>
    </div>

   	<div class="row block-center">
   		<div class="col-md-4 col-sm-4 col-xs-4 vbottom"></div>
   		<div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro*"   name="filtroEdo" style="padding-bottom:5px; cursor:pointer; vertical-align:baseline;">Todos</div>
   		@if(session.get("rolActual")=="100"){
   			<div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro4"  name="filtroEdo" style="padding-bottom:5px; cursor:pointer">Por atender</div>
   		}
        @if(session.get("rolActual")!="10"){
   		    <div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro5"  name="filtroEdo" style="padding-bottom:5px; cursor:pointer">Solicitudes</div>
        }
   		<div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro7"  name="filtroEdo" style="padding-bottom:5px; cursor:pointer">Autorizados</div>
        @if(Array("100","10") contains session.get("rolActual")){
            <div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro8" name="filtroEdo" style="padding-bottom:5px; cursor:pointer">E/A Asignados</div>
        }
        @if(Array("100","1") contains session.get("rolActual")){
            <div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro99" name="filtroEdo" style="padding-bottom:5px; cursor:pointer">Terminados</div>
            <div class="col-md-1 col-sm-1 col-xs-1 vbottom" id="filtro100" name="filtroEdo" style="padding-bottom:5px; cursor:pointer">Cancelados</div>
        }
   	</div>
    @form(routes.ProductorServiciosController.agenda(), 'role->"form", 'id->"frmAux") {
       @CSRF.formField
    }
         
    <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
        	<div class="x_panel">
          <table class="table table-bordered table-striped jambo_table bulk_action order-column" id="tablaMisServicios">               
              <thead>
                  <tr>
                      <th>NÃºmero folio</th>
                      <th>Remite</th>
                      <th>Descripcion</th>
                      
                      <th>Estado</th>

                  </tr>
              </thead>
          </table>             	
        	</div>
       
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6" style="min-height:300px;">
        	<div id="nav5" class="sidenav5" data-maximizado=false data-original-width="" data-original-height="" data-original-right="" data-original-top="" data-original-position="" data-original-padding="">
            <div class="x_panel">
            <div class="x_title">
                <h2 id="tituloDetalle"></h2>                    
                <ul class="nav navbar-right panel_toolbox">
                	<li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class=""></i></a>
                      <li><a id="hrefCorreoVentanaDetalle"><i class="far fa-envelope fa-fw"></i></a>
                      </li>
                  </li>
                 <li>
                 	<a id="hrefIconoToggle" onclick="javascript:toggleVentanaDetalle()"><i class="fa fa-expand fa-fw"></i></a>
                 </li>
                 <li>
                 	<a onclick="javascript:imprimirVentanaDetalle()"><i class="fas fa-print fa-fw" aria-hidden="true" ></i></a>
                 </li>
                </ul>
                <div class="clearfix"></div>
              </div>
              <div class="x-content">
              	<div id="observacionOficio"></div>
              	<div id="observacionFolio"></div>
            <table class="table table-bordered table-striped jambo_table bulk_action order-column dataTable no-footer" id="tablaMisServiciosDetalle">               
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Horario</th>                            
                        <th>Detalle</th>                            
                        <th>Estado</th>

                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                </tfoot>
            </table>   
            </div> 
            </div>
            </div>        
        </div>            
    </div>
}



<script>
	var laTablaDTSS;
	var laTablaDTSSDetalle;

	var rolActual = '@session.get("rolActual")';
	$(function(){
		
        $.notifyDefaults({
			type: 'success',
			newest_on_top: true,
			z_index: 999000
		});
        
        laTablaDTSS = $('#tablaMisServicios').DataTable( {     	
            pageLength: -1,
            lengthMenu: [  [1,3, 5, 10, 25, 50, -1], [1,3, 5, 10, 25, 50, "Todos"]   ],    
            language: {
                url: "@routes.Assets.at("Spanish.json")" 
            },
            processing: false,
            serverSide: true,
            //scrollY: 400,
            scrollY: '60vh',
            scrollCollapse: true,
            stateSave: true,
            scrollX: false,
            mark: true,
            ajax: {
                url:  "/adminea/misServiciosDTSS",
                data: { estado: @estado },
                contentType: "application/json; charset=utf-8",
                dataType: "json"
            },
            deferRender: true,
            "columns": [
                {"data": "folio"},
                {"data": "ur",          "visible": true,    "searchable": true},
                {"data": "descripcion"},
                {"data": "estado",      "visible": true,   "searchable": false,     "sortable":false},

                {"data": "id" , "visible": false, "searchable": false},
                {"data": "estadoId", "visible": false , "searchable": false}
              ],
            "initComplete": function(){
                $("#tablaMisServicios_wrapper div.row div").removeClass("col-sm-6");
                $("#tablaMisServicios_wrapper div.row div:eq(0)").addClass("col-sm-4");
                $("#tablaMisServicios_wrapper div.row div:eq(2)").addClass("col-sm-8");
                $(".dataTables_filter").css("width","auto");  

                //console.dir( laTablaDTSS.rows().data()  )


                @if(estado!=0){
                    toggleFiltro( $("#filtro@estado") );
                    @if(numFolio!=0){
                        $("#tablaMisServicios tbody tr").find("td:eq(0)").each(function(i,r){
                            console.log("tablita..."+ r.innerHTML   )
                            if (r.innerHTML == "@numFolio"){
                                $(r).click();
                            }
                        });
                    }
                }else{
                    seleccionaPrimerRenlon();
                }




                $('.popover, [data-toggle="popover"]').popover();
                
                
             //   $('div.dataTables_scrollBody').css("max-height", $(window).height()-400+"px" );
                
            }
        } );




		 toggleFiltro( $("#filtro5") );
		 
		 $.ajax({
			  url: "@routes.Application.notificaciones",
			  dataType: "json",
			}).done(function(datos) {
				if (datos!=null)
				  if ( datos.length !=0  ){
					  $("#bgNotificacion").html( datos.length  );
					  var lista = "";
	                	for (i=0;i<datos.length;i++){
	                        lista+="<li>";
	                        lista+="  <a>";
	
	               			lista+="    <span class='message'>";
	               			lista+="     "+datos[i].folio.numfolio+" - "+datos[i].folio.oficio.descripcion;
	           				lista+="    </span>";
	                   		lista+="      <span class='time'>3 mins ago</span>";           				
	       					lista+="  </a>";
	   						lista+="</li>";
	   						lista+="</ul>	";			  
	                }
					$("#menu1").html(lista);  
				  }
			});
		 
		 
	});

	
	
	$(document).off("keyup", "input[type='search'].form-control");
    $(document).on("keyup", "input[type='search'].form-control",function(){
    	seleccionaPrimerRenlon();
    	if( $(this).val().length >0 ){
    		$(this).addClass("filtrado");
    	} else {
    		$(this).removeClass("filtrado");
    	}
    }); 

	
    $("div [id^='filtro']").click(function(){
      var estado = $(this).attr('id').substring(6);
      laTablaDTSS.ajax.url( '/usuario/misServiciosDTSS?estado='+estado ).load(seleccionaPrimerRenlon);
      toggleFiltro(this);
      //borrarContenidoDetalle();

  }); 
	

    function seleccionaPrimerRenlon(){
    	borrarContenidoDetalle();
    	if ($("#tablaMisServicios tbody tr").length > 0){
	        $("#tablaMisServicios tbody").find("tr:first td:eq(0)").click();  
	        console.log("seleccionado el primer renglon")
    	}
    } 
	
    function seleccionaRenlonFolioId(){
    	borrarContenidoDetalle();
    	if ($("#tablaMisServicios tbody tr").length > 0){



	        $("#tablaMisServicios tbody").find("tr:first td:eq(0)").click();
	        console.log("seleccionado el primer renglon")
    	}
    }
	
	
	function toggleFiltro(e){		
		$("div[name='filtroEdo']").css("font-weight", "normal");
		$("div[name='filtroEdo']").css("border-bottom","3px solid #F2F2F2");
		$(e).css("font-weight", "bold");
		$(e).css("border-bottom","3px solid "+$(e).css("color"));


	}
	

 	//Al hacer click en la lista de los folios (td de tablaMisServicios) se muestran los servicios (agendados) del mismo  (en la tabla tablaMisServicios)
 	$("#tablaMisServicios").off("click", "td");
	 $("#tablaMisServicios").on("click", "td", function() {
		 $("#tablaMisServicios").find(".selected").removeClass("selected");
	     $(this).parent().hasClass("selected")?$(this).parent().removeClass("selected"):$(this).parent().addClass("selected");
	     $(this).parent().find("td:eq(0)").find("div [id^='fpa_']").css("visibility","visible");
	     var hiddenColumnValue = laTablaDTSS.row( $("#tablaMisServicios").find("tr:eq(2)")  );   
	     var d = laTablaDTSS.rows(   $(this).parent()     ).data();
	     if (d.length==0){
	    	 return false;
	     }
	     var id = d[0].id
	     var estadoId = d[0].estadoId
         $.when( LlamadaAjaxBuscaServiciosFolio(id, estadoId)  )
         .done( function(data){
        	 console.log("LlamadaAjaxBuscaServiciosFolio regresa....")
        	 console.log(data)
             if ( data!=null && data.length>0){            	 
                 if (estadoId == 4 ){
                	 var t= data[0].folio.oficio.titulo!=undefined&&data[0].folio.oficio.titulo.length>0?data[0].folio.oficio.titulo:data[0].folio.oficio.descripcion;
                     swal({
                         title: "Folio: "+data[0].folio.numfolio+" - "+t,
                         html: "Â¿Que desea hacer?<br><br><input type='button' value='Agendar' class='btn btn-success btn-lg' id='btnSwalAgendar'>"+                       
                               "<button type='button' class='btn btn-success btn-lg' id='btnSwalDetalle'>Info del Oficio</button>",
                         showCancelButton: true,
                         cancelButtonText: "Cerrar esta ventana",
                         showConfirmButton: false,
                         allowOutsideClick: false,
                         allowEscapeKey: true,
                         showLoaderOnConfirm: true,
                         animation: false,
                         customClass: 'animated bounceInDown',
                         preConfirm: function () {
                                return [
                                  $('#btnSwalAgendar').val(),
                                  $('#btnSwalInfo').val()
                                ]
                              }
                     }).catch(swal.noop);
                     
                     
                     $(document).off("click", "#btnSwalAgendar");
                     $(document).on("click", "#btnSwalAgendar", function(){
                         swal.close();
                         var extra2 = document.createElement("input");
                         extra2.setAttribute("type", "hidden");
                         extra2.setAttribute("name", "folio");
                   	  	 var celda = $("#tablaMisServicios tr.selected td:eq(0)").text();
                    	 if (celda.includes("<mark")){
                    		 celda= celda.substring( celda.indexOf(">")+1, celda.indexOf("</")  );
                    	 }
                         extra2.setAttribute("value",  celda ); 
                         var extra3 = document.createElement("input");
                         extra3.setAttribute("type", "hidden");
                         extra3.setAttribute("name", "tipo");
                         extra3.setAttribute("value", "agenda");           

                         $("#frmAux").append(extra2); 
                         $("#frmAux").append(extra3);                         
                         //poner tipo=agenda
                         $("#frmAux").submit();      
                     });                     
                     
                     
                     
                     // Muestra la informaciÃ³n detalle del evento
                     $(document).off("click", "#btnSwalDetalle");
                     $(document).on("click", "#btnSwalDetalle", function(){
                         swal.close();
                         $("#myModalDetalle").modal('show');      
                         var texto = "";
                         texto+="<div class='row' style='padding:10px'>";
                         texto+="    <div class='col-md-3'><strong>Folio:</strong> "+data[0].folio.numfolio+"</div><div class='col-md-9'><strong>Descripcion: </strong>"+data[0].folio.oficio.descripcion+"</div>";
                         texto+="</div>";
                         texto+="<div class='row' style='padding:10px'>";
                         texto+="    <div class='col-md-12'><strong>Oficio:</strong> "+data[0].folio.oficio.oficio+"</div>";
                         texto+="</div>";                         
                         texto+="<div class='row' style='padding:10px'>";
	                         if (data[0].folio.oficio.titulo!= null){
	                        	   texto+="    <div class='col-md-9'><strong>TÃ­tulo:</strong> "+data[0].folio.oficio.titulo+"</div>";
	                         }
                         texto+="    <div class='col-md-3'><strong>Fecha entrega:</strong> "+moment(data[0].folio.fechaentrega,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("DD/MM/YYYY")+"</div>";
                         texto+="</div>";

                         if (data[0].folio.observacion){
	                         texto+="<div class='row' style='padding:10px'>";
	                         texto+="    <div class='col-md-12'><strong>ObservaciÃ³n:</strong> "+data[0].folio.observacion+"</div>";
	                         texto+="</div>";                         
                         }
                         texto+="<div class='row' style='padding:10px'>";
                         texto+="    <div class='col-md-9'><strong>Remite/solicita:</strong> "+data[0].folio.oficio.urremitente.nombreLargo+"</div>";
                         texto+="    <div class='col-md-3'><strong>Fecha oficio:</strong> "+moment(data[0].folio.oficio.fecharemitente,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("DD/MM/YYYY")+"<br><strong>Fecha recibido:</strong> "+moment(data[0].folio.oficio.fecharecibidoupev,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("DD/MM/YYYY")+"</div>";
                         texto+="</div>";                         
                         if (data[0].folio.oficio.observacion){
                             texto+="<div class='row' style='padding:10px'>";
                             texto+="    <div class='col-md-12'><strong>ObservaciÃ³n:</strong> "+data[0].folio.oficio.observacion+"</div>";
                             texto+="</div>";                         
                         }
                         texto+="<div class='row' style='padding:10px'>";
                         texto+="    <div class='col-md-3'><strong>Servicio(s) solicitado(s):</strong><br>";
                                          data[0].folio.oficio.servicios.forEach(function(e){ texto+=e.servicio.descripcion+"    "});
                         texto+="    </div>";
                         if (data[0].folio.oficio.productoresSolicitados.length>0){
	                         texto+="    <div class='col-md-3'><strong>Productor(es) solicitado(s):</strong><br>";
	                                          data[0].folio.oficio.productoresSolicitados.forEach(function(ps){texto+=ps.personal.nombre+" "+ps.personal.paterno+" "+ps.personal.materno+"<br>"});
	                         texto+="    </div>";
                         }
                         if (data[0].folio.productoresAsignados.length>0){
                             texto+="    <div class='col-md-3'><strong>Productor(es) asignado(s):</strong><br>";
                                              data[0].folio.productoresAsignados.forEach(function(ps){texto+=ps.personal.nombre+" "+ps.personal.paterno+" "+ps.personal.materno+"<br>"});
                             texto+="    </div>";
                         }                 
                         

                         texto+="</div>";
                         
                         texto+="<div class='row' style='padding:10px'>";
                         if (data[0].folio.oficio.fechagrabaciones.length>0){
                             texto+="    <div class='col-md-3'><strong>Fecha/hora grabacion(es):</strong>";
                                              data[0].folio.oficio.fechagrabaciones.forEach(function(ps){texto+=moment(ps.inicio,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("DD/MM/YYYY HH:mm")+"<br>"});
                             texto+="    </div>";
                         }
                         texto+="</div>";
                         
                         
                         if (data[0].folio.oficio.contactos.length>0){
                        	   texto+="<div class='row' style='padding:10px 10px 0px 10px'>";                         
                        	   texto+="<div class='col-md-12'><strong>Contacto(s)</strong></div>";
                        	   texto+="</div>";
                               texto+="<div class='row' style='padding:0px 10px 0px 10px'>";                         
                               texto+="<div class='col-md-12'>";
                                   data[0].folio.oficio.contactos.forEach(function(ps){
                                          	texto+="<br><strong>Nombre: </strong>"+ps.nombre+"  <br>";
                                          	if (ps.telefonos.length>0){
                                          	    texto+="<strong>TelÃ©fono(s): </strong>";	                                                                                                  
	                                            ps.telefonos.forEach(function(t){
	                                                    texto+=t.telefono+"  ";
	                                            });
	                                            texto+="<br>";
	                                        }                                          	
                                            if (ps.correos.length>0){
                                                texto+="<strong>Correo(s): </strong>";                                                                                                      
                                                ps.correos.forEach(function(c){
                                                        texto+=c.correo+"  ";
                                                });
                                                texto+="<br>";
                                            }                                           	
                                            	  
                               });                                              
                             texto+="<br></div>";
                             
                         }                         
                         texto+="</div>";
                         $("#myModalDetalleContenido").html(texto);
                     });                     
                     
                     
                     
                     return false;
                 }
                 borrarContenidoDetalle();
               //Mostrar la info en la tabla de detalle
                 for(f=0; f<=data.length-1;f++){
                	 r = data[f];
                	 $("#tituloDetalle").html(r.folio.oficio.descripcion);
                	 //$("#observacionOficio").html( (r.folio.oficio.observacion)?"<span class='badge'>ObservaciÃ³n del oficio <i class='fas fa-exclamation'></i>&nbsp;</span> "+r.folio.oficio.observacion:"");
                	 if (r.folio.oficio.observacion){
                	 	var ce="";
	                 	ce+="<div class='table'>";
	                   	ce+="  <div class='table-row'>";
	                   	ce+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-right:none'><i class='fas fa-exclamation fa-2x'></i></div>";
	                   	ce+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-left:none'><strong>ObservaciÃ³n del oficio</strong></br>"+r.folio.oficio.observacion+"</div>";
	                   	ce+="  </div>";
	                   	ce+="</div>";
	                   	$("#observacionOficio").html( ce );
                	 }
                	 
                	 if (r.folio.observacion){
                 	 	var ce="";
	                 	ce+="<div class='table'>";
	                   	ce+="  <div class='table-row'>";
	                   	ce+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-right:none'><i class='fas fa-exclamation fa-2x'></i></div>";
	                   	ce+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-left:none'><strong>ObservaciÃ³n del folio</strong></br>"+r.folio.observacion+"</div>";
	                   	ce+="  </div>";
	                   	ce+="</div>";
	                   	$("#observacionFolio").html( ce );                		 
                	 }
                	 

                     var c = "";
                     if (estadoId=="*" &&  r.preagendas!=undefined && r.preagendas.length==0 && r.agenda.length==0)
                    	 {
                             // Se solicita todos los estados y si este en particular no tiene preagenda ni agenda, se trata de una solicitud sin atender
                             c="<td></td>";                                    
                             
                             c+="<td></td>";
                             c+="<td></td>";
                             c+="<td>@models.Estado.find.byId(4).descripcion</td>";
                             
                             c+="<td style='width:2em'><div class='center-block'><a href='javascript:verDetalles(null, \"preagenda\", "+r.id+")' style='margin-top:5px; margin-bottom:5px' > <i class='far fa-eye fa-lg fa-fw' aria-hidden='true'  title='Ver detalles'></i></a></br>";                             
                             c+="</div></td>";
                             $("#tablaMisServiciosDetalle tbody").append("<tr>"+c+"</tr>");
                             $("#tablaMisServiciosDetalle tfoot").html("<tr><td colspan='9'>Registrosa: "+$("#tablaMisServiciosDetalle tbody tr").length+"</td></tr>");
                         }                    	 

                     var arrAuxEdo = [];
                     console.log("---- r --------")
                     console.dir(r)
                     if ( "@session.get("rolActual")"!="10" )
                        arrAuxEdo.push(r.preagendas);
                     arrAuxEdo.push(r.agenda);
                     console.dir(arrAuxEdo)
                     for (h=0; h<arrAuxEdo.length;h++){
                     Edo = arrAuxEdo[h];
                     console.dir(Edo)
                     if (Edo.length!=0){
	                     for (i=0;i<Edo.length;i++){
	                    	   if (  (estadoId>=3  &&  Edo[i].tipo == "preagenda"  &&  estadoId < 7 && Edo[i].estado.id >=3 && Edo[i].estado.id < 7 )
	                    			 ||  
	                    			 (estadoId==7  &&  Edo[i].tipo == "agenda"  &&  Edo[i].estado.id ==7)
	                    			 ||
	                    			 (estadoId==8  &&  Edo[i].tipo == "agenda"  &&  Edo[i].estado.id ==8)
	                    			 ||  
	                    			 (estadoId==99 &&  Edo[i].tipo == "agenda"  &&  Edo[i].estado.id>7)
	                    			 ||  
	                    			 (estadoId==100 &&  Edo[i].tipo == "preagenda"  &&  Edo[i].estado.id==100 && estadoId == 100)
	                    			 ||
	                    			 (estadoId==100 &&  Edo[i].tipo == "agenda"  &&  Edo[i].estado.id==100)
	                    			 ||
                                     (estadoId=="*"  && (
                                    		 (Edo[i].tipo == "preagenda"  &&  (Edo[i].estado.id >=3 && Edo[i].estado.id < 7) || (Edo[i].estado.id == 100)  )
                                    		 ||
                                    		 (Edo[i].tipo == "agenda"  &&  Edo[i].estado.id >=7  ||  Edo[i].estado.id ==100  )
                                    		 )
                                     )
	                    		  ){       	 
		                         c = "<td>"+moment(Edo[i].inicio,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("DD/MM/YYYY") +"</td>";
		                         

		                         c+="<td>";
		                         if (Edo[i].salidas.length>0){
		                             c+="<p><strong>Salida</strong> "+moment(Edo[i].salidas[0].salida,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("HH:mm")+"</p>";		                             
		                         }
	                             if ( Edo[i].vehiculos.length!=0 ){
		                         	c+='<span class="badge"';
		                         	
		                         	if ( Edo[i].tipo=="preagenda" ){
		                         		c+='data-toggle="popover" data-title="VehÃ­culo" data-content="Auto solicitado" data-trigger="hover" data-container="body"';
		                         		c+='><i class="fas fa-car"></i>';
		                         	}
		                         	if ( Edo[i].tipo=="agenda" ){
		                         		c+='data-toggle="popover" data-title="VehÃ­culo" data-content="Auto asignado" data-trigger="hover" data-container="body"';
		                         		c+='><i class="fas fa-car"></i>';
		                         		for(j=0; j< Edo[i].vehiculos.length; j++){
		                         			c+=" "+Edo[i].vehiculos[j].vehiculo.placa;
		                         			c+=" "+Edo[i].vehiculos[j].vehiculo.descripcion.toLowerCase();
		                         		}
		                         	}                         	
		                         	c+='</span>'; 
		                         }		                         
		                         
	                             c+="<p><strong>Desde </strong> <span>"+moment(Edo[i].inicio,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("HH:mm")+"</span></p>";
	                             c+="<p><strong>Hasta</strong> <span>" +moment(Edo[i].fin,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("HH:mm") +"</span></p>";

	                             c+="</td>";
	                             
	                             
                                 c+="<td><div style='font-size:large; padding-bottom:0.3em'><strong>"+Edo[i].fase.descripcion;
                                 if (Edo[i].fase.id==1){
                                	 if (Edo[i].juntas.length>0){
                                		 c+=" - Junta de trabajo"
                                	 }
                                	 if (Edo[i].locaciones.length>0){
                                		 c+=" - scouting"
                                	 }                                	 
                                 }
                                 c+="</strong></div>";
                                 if (Edo[i].locaciones.length>0){
                                	 if (Edo[i].locaciones[0].locacion != null){
	                                	 c+="<p><strong>LocaciÃ³n</strong></br>";
	                                	 c+=Edo[i].locaciones[0].locacion;
	                                	 c+="</p>";
                                	 }
                                 }
                                 if (Edo[i].salas != undefined && Edo[i].salas.length >0){
                                	 c+="<p>";
                                 	c+="<span class='badge'>"+Edo[i].salas[0].sala.descripcion
                                 	if ( Edo[i].salas[0].usoscabina.length>0 ){
                                 		var uc="";
                                 		switch (Edo[i].salas[0].usoscabina[0].usocabina){
                                 			case "M": uc="<i class='fa fa-music'></i>"; break;  
                                 			case "V": uc="<i class='fa fa-comment'></i>"; break;
                                 			case "I": uc="<i class='fa fa-download'></i>"; break;
                                 			case "C": uc="<i class='fa fa-check'></i>"; break;  
                                 			case "R": uc="<i class='fa fa-flag'></i>"; break;
                                 		}
                                 		c+="&nbsp;&nbsp;"+uc;
                                 	} else {
                                 		// No aplica uso de cabina
                                 		c+="&nbsp;&nbsp;<i class='fas fa-pencil-alt'></i>"
                                 	}
                                 	c+="</span>";
                                 	c+="</p>";
                                 }
                                 if (Edo[i].tipo=="preagenda" && Edo[i].personal>0){
                                	 c+="<p><strong>Personal</strong></br>";
                                	 for (var j = 0; j<Edo[i].personal.length; j++){
                                		 if (Edo[i].personal[j].cantidad>0)
                                  			c+=Edo[i].personal[j].tipopersonal.descripcion+":"+Edo[i].personal[j].cantidad+"</br>";
                                	 }
                                	 c+="</p>";
                                  }
                                 
                                 console.dir( Edo[i]  )
                                  
                                 if (Edo[i].tipo=="agenda" && Edo[i].cuentaRol.length >=1){
                                	 console.dir(Edo[i].cuentaRol)
                                	 c+="<p><strong>Personal</strong></br>";
                                	 for (var j = 0; j<Edo[i].cuentaRol.length; j++){
                                		 	var p = Edo[i].cuentaRol[j].cuentarol.cuenta.personal;
                                  			c+=p.nombre+" "+p.paterno+" "+p.materno+"</br>";
                                	 }
                                	 c+="</p>";
                                  }
                                 if (Edo[i].tipo=="preagenda" && Edo[i].locutores.length >0){
                                	 c+="<p><strong>Locutores</strong></br>";
                                	 for (var j = 0; j<Edo[i].locutores.length; j++){
                                		 c+=Edo[i].locutores[j].personal.nombre+" "+Edo[i].locutores[j].personal.paterno+" "+Edo[i].locutores[j].personal.materno+"</br>";
                                	 }
                                	 c+="</p>";
                                  }                                 
                                 if (Edo[i].equipos.length >0 || Edo[i].accesorios.length >0 ){
                                	 c+="<p><strong>Equipo y accesorios</strong>";
	                                 if (Edo[i].equipos.length>0){
	                                	 for (var j = 0; j<Edo[i].equipos.length; j++){
		                                	 c+="<div class='mail-list' style= 'width: 100%; display: inline-block; line-height: initial;'>";         
		                                	 c+="<div class='left' style='    width: 5%; float:left;  margin-right:0.1em;'>-</div>";
		                                	 c+="<div class='right' style='width: 90%;  float: left;'>";	                                	 
	                                		 c+=""+Edo[i].equipos[j].equipo.descripcion+" "+Edo[i].equipos[j].equipo.modelo+" "+Edo[i].equipos[j].equipo.marca+" "+Edo[i].equipos[j].equipo.serie+" "+Edo[i].equipos[j].equipo.observacion+"";
	                                		 if (Edo[i].equipos[j].equipo.estado.id!=1 && moment(Edo[i].inicio).isSameOrAfter( moment(), 'day'  ))
	                                			 c+=" <div class='conError mismaLinea'>"+Edo[i].equipos[j].equipo.estado.descripcion+"</div>";
			                                 c+="</div>";
			                                 c+="</div>";                                		 
	                                	 }
	                                 }                                 
	                                 if (Edo[i].accesorios.length >0){                                	 
	                                	 for (var j = 0; j<Edo[i].accesorios.length; j++){
		                                	 c+="<div class='mail-list' style= 'width: 100%; display: inline-block; line-height: initial;'>";         
		                                	 c+="<div class='left' style='    width: 5%;   float: left;  margin-right: 0.1em;'>-</div>";
		                                	 c+="<div class='right' style='width: 90%;  float: left;'>";		                                		 
	                                		 c+=""+Edo[i].accesorios[j].accesorio.descripcion+" "+Edo[i].accesorios[j].accesorio.modelo+" "+Edo[i].accesorios[j].accesorio.serie+" "+Edo[i].accesorios[j].accesorio.observacion;
	                                		 if (Edo[i].accesorios[j].accesorio.estado.id!=1 && moment(Edo[i].inicio).isSameOrAfter( moment(), 'day'  ))
	                                			 c+=" <div class='conError mismaLinea'>"+Edo[i].accesorios[j].accesorio.estado.descripcion+"</div>";
			                                 c+="</div>";
			                                 c+="</div>";
	                                	 }
	                                  }         
                                 	 c+="</p>";
                                 }
                                 
                                 if (Edo[i].formatos!=undefined &&  Edo[i].formatos.length>0){
                                	 c+="<p><strong>Formatos</strong></br>";
                                	 for (var j = 0; j<Edo[i].formatos.length; j++){
                                		 if (Edo[i].formatos[j].cantidad>0)
                                		 	c+=Edo[i].formatos[j].formato.descripcion+": "+Edo[i].formatos[j].cantidad+"</br>";	 
                                	 }
                                	 c+="</p>";
                                 }
                                 
                                 if (Edo[i].observacion){
                                	 /*
                                	 c+="</br></br><span class='badge'><strong>ObservaciÃ³n &nbsp;<i class='fas fa-exclamation fa-3x'></i></strong>&nbsp;</span></br>";
                                	 c+=Edo[i].observacion;
                                	 */
                                	 

                                	 
                                	 
                                //	 c+="<div><div class='left' role='alert'><i class='fas fa-exclamation fa-2x'></i></div><strong>ObservaciÃ³n: </strong><div class='right'>"+Edo[i].observacion+"</div></div>";
                                	 
                                	c+="<div class='table'>";
	                               	c+="  <div class='table-row'>";
	                               	c+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-right:none'><i class='fas fa-exclamation fa-2x'></i></div>";
	                               	c+="    <div class='table-cell bg-warning' style='vertical-align:middle; border-left:none'><strong>ObservaciÃ³n </strong></br>"+Edo[i].observacion+"</div>";
	                               	c+="  </div>";
	                               	c+="</div>";
                                	 
                                 }
                                 
                                 c+="</td>";
                                 
                                 
                                 
	                             c+="<td>"+Edo[i].estado.descripcion;
                                 if (Edo[i].estado.id == 7 && Edo[i].fase.id == 2)
                                    c+="<p style='margin-top:10px'><strong>En espera que el Ing. asigne el equipo y accesorios</strong></p>";
	                             if (Edo[i].estado.id==100){
	                            	 c+="</br></br><p><strong>Motivo</strong></br>"+Edo[i].cancelaciones[0].motivo.descripcion+"</p>";
	                            	 if (Edo[i].cancelaciones[0].observacion)
	                            		 c+="<p><strong>ObservaciÃ³n</strong></br>"+Edo[i].cancelaciones[0].observacion+"</p>";
	                             }
	                             c+="</td>";
	                             if (Edo[i].estado.id > 4){
	                                c+="<td style='width:2em'><div class='center-block'><a href='javascript:verDetalles("+Edo[i].id+", \""+Edo[i].tipo+"\", "+r.id+")' style='margin-top:5px; margin-bottom:5px' > <i class='far fa-eye fa-lg fa-fw' aria-hidden='true'  title='Ver detalles'></i></a></br>";
                                    if ( [1, 100].includes(@session.get("rolActual"))){
	                                    c+="<a href='javascript:eliminarEvento("+Edo[i].id+", \""+Edo[i].tipo+"\")' style='margin-top:5px; margin-bottom:5px' > <i class='far fa-trash-alt fa-lg fa-fw' aria-hidden='true'  title='Eliminar'></i></a></br>";
                                    }
	                                c+="<a href='javascript:irAFechaEvento(\""+moment(Edo[i].inicio,"YYYY-MM-DDTHH:mm:ss.SSSSZ").format("YYYY-MM-DD")+"\",\""+Edo[i].id+"\", \""+Edo[i].tipo+"\")' style='margin-top:5px; margin-bottom:5px' > <i class='far fa-calendar fa-lg fa-fw' aria-hidden='true'  title='Ver en agenda'></i></a>";
	                                if (Edo[i].estado.id == 7){
	                                	c+="<a href='javascript:terminar("+Edo[i].id+", \"individual\")' style='margin-top:5px; margin-bottom:5px' > <i class='far fa-star fa-lg fa-fw' aria-hidden='true'  title='Marcar como terminado'></i></a>";
	                                	c+="<a href='javascript:cancelarEvento("+Edo[i].id+")' style='margin-top:5px; margin-bottom:5px' > <i class='fas fa-ban fa-lg fa-fw' aria-hidden='true'  title='Cancelar'></i></a>";	                                
	                                }
	                                c+="</div></td>";
	                             }
	                             c+="<td class='hidden'>"+Edo[i].id+"</td>";
	                             c+="<td class='hidden'>"+Edo[i].estado.id+"</td>";
	                             $("#tablaMisServiciosDetalle tbody").append("<tr>"+c+"</tr>");
	                             $("#tablaMisServiciosDetalle tfoot").html("<tr><td colspan=\"9\"'>Registros: <div id='contadorDetalle' class='mismaLinea'>"+$("#tablaMisServiciosDetalle tbody tr").length+"</div></td></tr>");
	                         }
	                     }                	 
                     } 
                     }
                 }

             }
         })
         .fail(function(){
            	 alert("error 12345");
             });	     
	   }); 
	 
	 
	 

	 function borrarContenidoDetalle(){
	      $("#tablaMisServiciosDetalle tbody, #tablaMisServiciosDetalle tfoot").empty();
	         $("#tituloDetalle, #observacionOficio, #observacionFolio").html("");
	 }   	
	 
	 $('#tablaMisServicios').off( 'page.dt');
	 $('#tablaMisServicios').on( 'page.dt', function () {
		 borrarContenidoDetalle();
		} );	 
	 
	 

	 
	 

	 
	 
     function irAFechaEvento(fecha, eventoId, tipo){
         var extra1 = document.createElement("input");
         extra1.setAttribute("type", "hidden");
         extra1.setAttribute("name", "fecha");
         extra1.setAttribute("value", fecha);
         
         var extra2 = document.createElement("input");
         extra2.setAttribute("type", "hidden");
         extra2.setAttribute("name", "eventoId");
         extra2.setAttribute("value", eventoId);
         
         var extra3 = document.createElement("input");
         extra3.setAttribute("type", "hidden");
         extra3.setAttribute("name", "tipo");
         extra3.setAttribute("value", tipo);           

         $("#frmAux").append(extra1);
         $("#frmAux").append(extra2);
         $("#frmAux").append(extra3);

    	 $("#frmAux").attr("action", "/productorServicios");
    	 $("#frmAux").attr("method","POST");
    	 $("#frmAux").submit();
     }
     
     $("#tablaMisServiciosDetalle").off("click", "td");
     $("#tablaMisServiciosDetalle").on("click", "td", function() {
         $("#tablaMisServiciosDetalle").find(".selected").removeClass("selected");
         $(this).parent().hasClass("selected")?$(this).parent().removeClass("selected"):$(this).parent().addClass("selected");     
     });     
     
     
     
     
     function eliminarEvento(servicioId, tipo){
    	    swal({
    	        title: "Â¿Desea eliminar el evento?",                
    	        type: "warning",
    	        showCancelButton: true,
    	        confirmButtonColor: "#d33",
    	        cancelButtonColor: '#3085d6',
    	        confirmButtonText: "Si, borrar el evento.",
    	        cancelButtonText: "No, cancelar borrado.",
    	        preConfirm: function(){
    	            return new Promise(function (resolve, reject) {                 
    	                var evento = new Object();
    	                evento.id = servicioId;
    	                evento.tipo = tipo;
    	                //LLamada al controlador para eliminar evento
    	                $borrado=null;                  
    	                if (   @session.get("rolActual")=="1")
    	                    $borrado = LlamadaAjaxEliminaEventoAdmin(evento);    
    	                if (@session.get("rolActual")=="100")    
    	                    $borrado = LlamadaAjaxEliminaEvento(evento);
    	                  
    	                $.when($borrado).done(
    	                        function(data){
    	                            if (data.eliminado){
    	                                //swal("Eliminado", "Se eliminÃ³ correctamente el evento.", "success");
    	                                $("#btnModalCancelar").click();
    	                                $("#tablaMisServiciosDetalle tr.selected").fadeOut(800, function() {
    	                                    $(this).remove();
    	                                    $("#contadorDetalle").html(  $("#tablaMisServiciosDetalle tbody tr").length);
    	                                });
    	                                                                     
    	                                resolve()
    	                            } else {
    	                                reject("No fue posible eliminar el evento.");
    	                            }
    	                        }
    	                );                      
    	            });
    	        }
    	      }).then(function () {
    	            swal(
    	                      'Eliminado!',
    	                      'Se eliminÃ³ correctamente el evento.',
    	                      'success'
    	                    )
    	      }, function (dismiss) {
    	            if (dismiss === 'cancel') {
    	              swal(
    	                'Cancelado',
    	                'Usted cancelÃ³ la eliminaciÃ³n del evento.<br>Se conserva el evento.',
    	                'error'
    	              )
    	            }
    	      });        
    	}     
	
     
     $('.popover, [data-toggle="popover"]').popover();

     
     
     function toggleVentanaDetalle(){    	 
    	 if (!$("#nav5").data("maximizado")){
    		 // Expandir el div    		 
    		 $("#nav5").data("maximizado",  true );
    		 $("#hrefIconoToggle").html("<i class='fa fa-compress fa-lg'></i>");
    		 $("#nav5").data("original-width",  $("#nav5").css("width") );
    		 $("#nav5").data("original-height",  $("#nav5").css("height") );
    		 $("#nav5").data("original-right",  $("#nav5").css("right") );
    		 $("#nav5").data("original-top",  $("#nav5").css("top") );
    		 $("#nav5").data("original-position",  $("#nav5").css("position") );
    		 $("#nav5").data("original-padding",  $("#nav5").css("padding") );
    		 
    	    document.getElementById("nav5").style.width = "100%";
    	    document.getElementById("nav5").style.right = "0";   
    	    document.getElementById("nav5").style.height = "100%";
    	    document.getElementById("nav5").style.top = "0";   
    	    document.getElementById("nav5").style.position = "fixed";
    	    document.getElementById("nav5").style.backgroundColor = "white";
    	    document.getElementById("nav5").style.padding = "20px 10px 20px 10px";
    	  //  document.getElementById("nav5").style.margin = "20px 10px 5750px 10px";
    	 } else {
    		 // Contraer el div
    		$("#nav5").data("maximizado",  false );    		
    		$("#hrefIconoToggle").html("<i class='fa fa-expand fa-lg'></i>");
     	    document.getElementById("nav5").style.width =  $("#nav5").data("original-width");
     	   //document.getElementById("nav5").style.height =  $("#nav5").data("original-height");
     	   document.getElementById("nav5").style.height =  "100%";
     	    document.getElementById("nav5").style.right =  $("#nav5").data("original-right");
     	    
     	   document.getElementById("nav5").style.top =  $("#nav5").data("original-top");
     	    document.getElementById("nav5").style.position =  $("#nav5").data("original-position");
     	    document.getElementById("nav5").style.padding =  $("#nav5").data("original-padding");
 		 
    	 }
     }
     
     function imprimirVentanaDetalle(){
    	 /*
    	 var DocumentContainer = document.getElementById('tablaMisServiciosDetalle');
    	    var WindowObject = window.open('', 'PrintWindow', 'width=750,height=650,top=50,left=50,toolbars=no,scrollbars=yes,status=no,resizable=yes');
    	    WindowObject.document.writeln(DocumentContainer.innerHTML);
    	    WindowObject.document.close();
    	    WindowObject.focus();
    	    WindowObject.print();
    	    WindowObject.close();
    	    */
    	    
/*     	    $("#tablaMisServiciosDetalle").printThis(
    	    		{
    	    			 importCSS: true,
    	    			 loadCSS: "@routes.Assets.at("lib/font-awesome/on-server/css/fontawesome-all.min.css")"
    	    		}
    	    		); */
    	    		
   			printJS({printable: 'tablaMisServiciosDetalle', type:'html',
   				maxWidth: '1080'});	
    	    		
    	    		
    	    		
     }
     
     
     
     
     function terminar(eventoId){
    	  var celda = $("#tablaMisServicios tr.selected td:eq(0)").text();
    	 if (celda.includes("<mark")){
    		 celda= celda.substring( celda.indexOf(">")+1, celda.indexOf("</")  );
    	 }
 		  var conf = confirm("Â¿Dar por terminado el servicio del folio "+celda+" del dÃ­a "+
 				  $("#tablaMisServiciosDetalle tr.selected td:eq(0)").text()+
 				  " de las "+$("#tablaMisServiciosDetalle tr.selected td:eq(1)").find("span:eq(-2)").text()+
 				  " a las " +$("#tablaMisServiciosDetalle tr.selected td:eq(1)").find("span:last").text()+"?");
 		  if (conf){
               $.ajax({
                   url: '/ajaxTableroTerminarEvento',
                   method: 'POST',
                   data: JSON.stringify( {eventoId: eventoId }),
                   contentType: "application/json; charset=utf-8",
                   dataType: "json"
               }).success(function(data){       
                   $.notify(
                           "Se marcÃ³ como terminado el evento"
                       );  
                   $("#tablaMisServiciosDetalle tr.selected").fadeOut(800, function() {
                       $(this).remove();
                       $("#contadorDetalle").html(  $("#tablaMisServiciosDetalle tbody tr").length);
                   });
                                        
               })
 	      }	  
   }   
     
     
     function cancelarEvento(servicioId){
    		// Genera las opciones para motivo de cancelaciÃ³n  
    		  var inputOptionsPromise = new Promise(function(resolve) {
    				  resolve({
    					  @for(m <-models.MotivoCancelacion.find.all()){
    						  @m.id : "@m.descripcion",
    					  }
    				  });
    			})	  
    			swal({
    				  type: 'question',
    			      title: 'Â¿Motivo de cancelaciÃ³n?',
    			      input: 'select',
    			      inputOptions: inputOptionsPromise,
    			      inputPlaceholder: 'Seleccione motivo',
    			      showCancelButton: true,
    			      confirmButtonText: "Cancelar",
    			      cancelButtonText: "Sin cancelar",
    			      inputValidator: function(value) {
    			        return new Promise(function(resolve, reject) {
    			          if (value != '') {
    			            resolve();
    			          } else {
    			            reject('Seleccione un motivo')
    			          }
    			        })
    			      }
    			    }).then(function(result) {
    			   	  $cancela =  LlamadaAjaxCancelaEvento(servicioId, result); 
    			  	  $.when($cancela).done(function(datac){
    			  		  if (datac.cancelado){
    			  			$.notify("Se cancelÃ³ el evento");
    		                   $("#tablaMisServiciosDetalle tr.selected").fadeOut(800, function() {
    		                       $(this).remove();
    		                       console.log("renglon removido")
    		                   $("#contadorDetalle").html(  $("#tablaMisServiciosDetalle tbody tr").length);
    		                   console.log("contador actualizado a ",$("#tablaMisServiciosDetalle tbody tr").length)    		                       
    		                   });

    			  		  } else {
    	                      $.notify(
    	                              "No se pudo cancelar el evento"
    	                          ,{
    	                          	type:"danger"
    	                          }); 
    			  		  }
    			  	  });
    			    })	  
    		}      
     
     
     
    
     
     
</script>



    <script src="@routes.Assets.at("gentelella/vendors/datatables.net/js/jquery.dataTables.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-buttons/js/dataTables.buttons.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-buttons/js/buttons.flash.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-buttons/js/buttons.html5.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-buttons/js/buttons.print.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-responsive/js/dataTables.responsive.min.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js")"></script>
    <script src="@routes.Assets.at("gentelella/vendors/datatables.net-scroller/js/dataTables.scroller.min.js")"></script>
       
    
    
    
    
    <!-- Chart.js -->
    <script src="@routes.Assets.at("gentelella/vendors/Chart.js/dist/Chart.min.js")"></script>
    <!-- jQuery Sparklines -->
    <script src="@routes.Assets.at("gentelella/vendors/jquery-sparkline/dist/jquery.sparkline.min.js")"></script>
    <!-- easy-pie-chart -->
    <script src="@routes.Assets.at("gentelella/vendors/jquery.easy-pie-chart/dist/jquery.easypiechart.min.js")"></script>    
    

    <script src="@routes.Assets.at("javascripts/detalleServiciosAjax.js")"></script>
    <script src="@routes.Assets.at("javascripts/agendaAjax.js")"></script>
    <script src="@routes.Assets.at("lib/moment/min/moment.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("lib/moment/locale/es.js")" type="text/javascript"></script>
    
    <script src="@routes.Assets.at("mark.js/datatables.mark.min.js")"></script>
    <script src="@routes.Assets.at("mark.js/jquery.mark.min.js")"></script>    
    
    <script src="@routes.Assets.at("javascripts/misServicios.js")"></script>
<!-- 	<script src="@routes.Assets.at("printThis/printThis.js")"></script> -->     
	
	<script src="@routes.Assets.at("print.js/print.min.js")"></script>   
	<link href="@routes.Assets.at("print.js/print.min.css")" rel="stylesheet">    
	<link href="@routes.Assets.at("stylesheets/fa-personalizados.css")" rel="stylesheet">

		<script src="@routes.Assets.at("bootstrap-notify/bootstrap-notify.min.js")"></script>
	
	